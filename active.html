<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="utf-8" />
    <title>Sharing-Loading</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body style="background-color: #FFFFFF;">
    <div class="centerScreen">
        <img src="https://ongkub.github.io/sparkth/img/gsbnow.png" width="800px" />
        <div>
            <h1>ชวนเพื่อนใหม่ร่วมกิจกรรม GSB NOW</h1>
        </div>
        <div class="container">
            <div class="progress2 progress-moved">
                <div class="progress-bar2"></div>
            </div>
        </div>
        <div>
            <p>Now Loading…</p>
            <p id="status-message" style="font-weight: bold;"></p>
        </div>
    </div>
    <div><div class="circleTopLeft"></div></div>
    <div class="bottomRight"><div class="circleBottomRight"></div></div>
    <script>
        async function main() {
            await liff.init({ liffId: "2004737575-2Vnw1oNd" });
            if (!liff.isLoggedIn()) {
                liff.login({ redirectUri: window.location.href });
                return;
            }
            
            const statusMessage = document.getElementById('status-message');
            
            if (!liff.isApiAvailable('shareTargetPicker')) {
                statusMessage.textContent = "ไม่สามารถแชร์คอนเทนต์ได้";
                return;
            }
            
            try {
                // 1. ดึง Profile (คงเดิม)
                const profile = await liff.getProfile();
                const userUID = profile.userId;
                const displayName = encodeURIComponent(profile.displayName); // สำหรับ URL
                const rawName = profile.displayName; // สำหรับแสดงใน Flex Text
                
                // 2. Fetch Flex Message (คงเดิม)
                const response = await fetch('https://ongkub.github.io/sparkth/flex/share.json');
                const flexMessage = await response.json();
                
                // 3. [ส่วนที่เพิ่มใหม่] แทนที่ชื่อ {name} ใน JSON ทั้งหมด
                let flexString = JSON.stringify(flexMessage);
                flexString = flexString.replace(/{name}/g, rawName);
                const updatedFlex = JSON.parse(flexString);
                
                // 4. [Logic เดิม] อัปเดต URI ในปุ่ม (ปรับมาใช้ updatedFlex เพื่อความสมบูรณ์)
                if (updatedFlex.contents && updatedFlex.contents.footer && updatedFlex.contents.footer.contents) {
                    updatedFlex.contents.footer.contents.forEach(content => {
                        if (content.type === 'box' && content.contents) {
                            content.contents.forEach(innerContent => {
                                if (innerContent.type === 'button' && innerContent.action && innerContent.action.uri) {
                                    const baseUrl = innerContent.action.uri.replace('{param}', userUID);
                                    innerContent.action.uri = `${baseUrl}&name=${displayName}`;
                                    console.log('✅ Updated button URI:', innerContent.action.uri);
                                }
                            });
                        }
                    });
                }
                
                // 5. ส่ง Flex Message (ส่งตัวแปรที่อัปเดตชื่อแล้ว)
                const result = await liff.shareTargetPicker([updatedFlex]);
                
                if (result) {
                    statusMessage.style.color = 'green';
                    statusMessage.textContent = "เชิญเพื่อนของคุณเรียบร้อย!";
                } else {
                    statusMessage.style.color = 'orange';
                    statusMessage.textContent = "คุณยกเลิกการเชิญเพื่อน";
                }
            } catch (error) {
                statusMessage.style.color = 'red';
                statusMessage.textContent = "เกิดข้อผิดพลาด: " + error.message;
            } finally {
                if (liff.isInClient()) {
                    setTimeout(() => {
                        liff.closeWindow();
                    }, 2000); 
                }
            }
        }
        main();
    </script>
</body>
</html>
